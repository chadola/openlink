
这是一个为你量身定制的 **ground-link(浏览器本地代理)** 产品需求文档 (PRD)。

这份文档将作为我们开发的蓝图，整合了我们之前讨论的所有核心决策：**XML 协议**、**目录沙箱**、**超时控制** 以及 **人工确认机制**。

---

# 产品需求文档 (PRD)

**项目名称**：ground-link
**版本号**：v1.0 (MVP)
**文档状态**：已冻结
**负责人**：Afumu
**日期**：2026-02-19

---

## 1. 项目概述 (Project Overview)

### 1.1 背景

当前网页版大模型（如 DeepSeek, ChatGPT, Claude）能力强大，但受限于浏览器沙箱，无法直接读取、修改或执行用户的本地文件。用户在进行代码开发、数据处理时，需要频繁地在“浏览器”和“本地终端/编辑器”之间复制粘贴，不仅效率低下，而且打断了思维流（Flow）。

### 1.2 目标

构建一个“浏览器插件 + 本地 Go 服务”的桥梁系统。
通过标准化协议，使网页版大模型能够安全、受控地调用用户本地的文件系统和工具，实现“对话即操作”。

### 1.3 核心价值

1. **打破边界**：让 Web AI 拥有本地文件读写能力。
2. **安全可控**：通过“目录沙箱”和“人工确认”机制，确保操作不越界。
3. **无缝体验**：消除“复制粘贴”的繁琐步骤，实现半自动化工作流。

---

## 2. 核心用户流程 (User Flow)

1. **启动阶段**：
* 用户在终端启动 Go Server，指定工作目录：`./server -dir="/Users/afumu/workspace"`。
* Go Server 启动并在本地端口 (如 :8080) 监听。


2. **交互阶段**：
* 用户在浏览器打开大模型网页（如 DeepSeek）。
* 插件自动连接本地服务，状态变为🟢 **已连接**。
* 用户输入 Prompt（例如：“帮我分析当前目录下的 `data.csv`”）。


3. **拦截与解析**：
* 大模型返回包含 `<tool>...</tool>` 的响应。
* 插件拦截到该标签，暂停自动流式输出（或并在旁侧显示）。


4. **决策阶段**：
* **模式 A (人工确认)**：插件在网页弹出卡片：“DeepSeek 请求读取 `data.csv`，是否允许？” -> 用户点击【允许】。
* **模式 B (自动模式)**：直接放行（仅限低风险操作，MVP 建议默认关闭）。


5. **执行与反馈**：
* 插件将指令发送给 Go Server。
* Go Server 在沙箱内执行，返回结果。
* 插件将结果自动填入输入框，并自动发送给大模型。



---

## 3. 功能需求 (Functional Requirements)

### 3.1 通信协议 (The Protocol)

大模型与插件之间的交互必须遵循以下严格格式。

* **触发标签**：`<tool>` 和 `</tool>`
* **数据格式**：纯 JSON
* **Schema 定义**：
```json
{
  "name": "工具名称 (string)",
  "args": {
    "参数名": "参数值" 
  },
  "reason": "操作理由 (string, 可选)"
}

```


* **示例**：
```xml
<tool>
{"name": "read_file", "args": {"path": "./configs/config.yaml"}}
</tool>

```



### 3.2 浏览器插件 (Browser Extension)

* **Manifest V3 架构**。
* **功能模块**：
1. **HTTP 拦截器 (Injector)**：注入 `script` 到页面主世界，劫持 `XMLHttpRequest` 或 `fetch`，监听流式响应。
2. **解析器 (Parser)**：实时正则匹配 `<tool>` 标签。
3. **交互 UI (Content Script)**：
* 在检测到工具调用时，在对话气泡旁渲染一个 **[执行控制面板]**。
* 面板包含：工具名、参数预览、**[运行]** 按钮、**[拒绝]** 按钮。


4. **回填器 (Injector)**：
* 查找页面当前的 `<textarea>` 或 `contenteditable` 元素。
* 模拟用户输入（Input Event）。
* 模拟点击发送按钮。





### 3.3 本地服务端 (Go Server)

* **基础架构**：使用 Gin 或标准库 `net/http`。
* **核心 Skills (MVP)**：
1. `ls` (list_dir): 列出当前沙箱目录下的文件。
2. `read` (read_file): 读取指定文件内容（仅限文本）。
3. `write` (write_file): 覆盖或追加内容到文件。
4. `cmd` (exec_cmd): 执行 Shell 命令 (**高危**，需特殊标记)。


* **API 接口**：
* `POST /exec`: 接收 JSON，执行并返回 `{ "output": "...", "status": "success" }`。
* `GET /health`: 心跳检测，返回 `{ "dir": "/current/sandbox" }`。



---

## 4. 非功能性需求 (Non-Functional Requirements)

### 4.1 安全性 (Security) - **最高优先级**

1. **目录沙箱 (Directory Jail)**：
* **强制限制**：所有文件操作路径必须经过 `SafePath` 函数校验。
* **校验逻辑**：`filepath.Clean(target_path)` 必须以 `filepath.Clean(root_dir)` 开头。
* **禁止越狱**：严禁访问 `../` 导致跳出根目录。


2. **网络隔离**：
* Go Server 默认绑定 `127.0.0.1`，严禁绑定 `0.0.0.0`，防止局域网攻击。


3. **高危命令阻断**：
* 对于 `rm`, `mkfs`, `dd` 等毁灭性 Shell 命令，建议在 Go 代码层做硬编码黑名单拦截。



### 4.2 性能与稳定性

1. **超时机制 (Timeout)**：
* 所有本地操作必须在 **60秒** 内完成（可配置）。
* 使用 Go `context.WithTimeout` 控制。
* 超时后强制 Kill 进程，并返回 "Error: Execution Timed Out"。


2. **并发锁**：
* MVP 阶段，Go Server 处理请求应为 **串行**，避免大模型并发写入同一个文件导致死锁。



---

## 5. UI/UX 设计草图

### 5.1 插件 Popup (点击浏览器右上角图标)

```text
+-----------------------------------+
|  🤖 GhostHand Bridge              |
|-----------------------------------|
|  状态: 🟢 已连接                  |
|  端口: 8080                       |
|-----------------------------------|
|  当前沙箱:                        |
|  /Users/afumu/Projects/Demo       |
|-----------------------------------|
|  [ ] 总是询问 (推荐)              |
|  [ ] 自动执行 (风险)              |
+-----------------------------------+

```

### 5.2 网页内拦截气泡 (In-Page Widget)

当大模型输出 XML 时，在内容下方显示：

```text
+--------------------------------------------------+
| 🛠️ 检测到工具调用: [write_file]                   |
| 参数: filename="main.go"                          |
| ------------------------------------------------ |
| [ ▶️ 运行 ]      [ ❌ 忽略 ]      [ 👁️ 查看内容 ] |
+--------------------------------------------------+

```

---

## 6. 技术栈选型

| 模块 | 技术选型 | 理由 |
| --- | --- | --- |
| **Server** | **Go (Golang)** | 高并发、跨平台、文件系统操作极其便利，方便你未来集成 gorm 等库。 |
| **Server Web** | **Gin / Standard Lib** | 轻量级，API 开发快。 |
| **Extension** | **Chrome Manifest V3** | 现代浏览器标准，JS/TS 开发。 |
| **RPC** | **HTTP REST + JSON** | 简单通用，易于调试。 |

---

## 7. 实施路线图 (Roadmap)

### Phase 1: 核心联调 (Day 1-2)

* [后端] 完成 Go Server 基础搭建，实现 `/exec` 和 `SafePath` 沙箱逻辑。
* [后端] 实现 `read_file` 技能。
* [前端] 完成 Manifest 配置，实现简单的 `fetch` 拦截并打印日志。
* **里程碑**：手动发送 curl 请求给 Go Server 能读到文件；浏览器控制台能看到大模型的 XML。

### Phase 2: 交互闭环 (Day 3-4)

* [前端] 实现 `<tool>` 标签的正则解析。
* [前端] 实现“回填输入框”和“自动发送”逻辑。
* [后端] 增加 `write_file` 和 `exec_cmd`。
* **里程碑**：在网页让大模型写一个 "Hello World" 文件，本地硬盘真的出现了该文件。

### Phase 3: 安全与优化 (Day 5)

* [后端] 加上 `context` 超时控制。
* [前端] 完善 UI，增加“确认/拒绝”按钮。
* [测试] 尝试攻击沙箱（比如读取 `../../password.txt`），确保被拦截。


